---
layout: post
title: "[PHP] Blog"
date: 2022-04-08
excerpt: "PHP Blog with MySQL"
tags: [PHP, MySQL, VSCode]
comments: false
---

# IDE

## PHP
  - download : <a href="https://www.php.net/downloads.php">https://www.php.net/downloads.php</a>
  - Change download folder name to `php`.
  - Move Download folder to `C:\`.
  - Add `C:\php` on path.
  - Manual : <a href="https://www.php.net/manual/en/">https://www.php.net/manual/en/</a>

## MySQL
  - download : <a href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a>
  - Add `c:\Program Files\MySQL\MySQL Server X.X\bin` on path.

# Functions

## File Upload & Download

### GET
  - `$_SERVER` is a global variable for server.
  - You can get requested methods from `REQUEST_METHOD`.
  - You can write HTML code in php with `<<<'HTML'...HTML;`.

### POST
  - `$_FILES` is a global variable for array of items uploaded to the current HTTP POST method.
  - `pathinfo` returns file path via array.
  - `__FILE__` means current file.

{% highlight php %}
<?php

switch($_SERVER['REQUEST_METHOD']){
    case 'GET':
        echo <<<'HTML'
        <form action="/" method='POST' enctype="multipart/form-data">
            <input type="file" name="uploads" />
            <input type="submit" />
        </form>
        HTML;
        break;
    case 'POST':
        $file = $_FILES['uploads'];
        $pathinfo = pathinfo($file['name']);
        $accepts = [
            'png', 'jpg', 'txt'
        ];
        if(in_array(strtolower($pathinfo['extension']), $accepts) && is_uploaded_file($file['tmp_name'])){
            move_uploaded_file($file['tmp_name'], dirname(__FILE__) . '/uploads/' . $file['name']);
        }
        break;
    default:
        http_response_code(404);
}
{% endhighlight %}

<figure class="third">
  <a href="/assets/img/posts/php_blog/0.jpg"><img src="/assets/img/posts/php_blog/0.jpg"></a>
  <a href="/assets/img/posts/php_blog/1.jpg"><img src="/assets/img/posts/php_blog/1.jpg"></a>
  <a href="/assets/img/posts/php_blog/2.jpg"><img src="/assets/img/posts/php_blog/2.jpg"></a>
  <figcaption>PHP File Upload and Download</figcaption>
</figure>

### Download
  - `header` sends a raw HTTP header.
  - `realpath` is for the security. If there is no filename like the argument, return null.

{% highlight php %}
<?php

$path = 'HelloWorld.txt';
$filepath = realpath(dirname(__FILE__) . '/uploads/' . $path);

if(file_exists($filepath)){
    $pathinfo = pathinfo($filepath);
    $accepts = [
        'txt'
    ];
    if(in_array(strtolower($pathinfo['extension']), $accepts)){
        header('Content-type: application/octet-stream');
        header('Content-Disposition: attachment; filename=' . basename($filepath));
        header('Content-Transfer-Encoding: binary');
        header('Content-Length: ' . filesize($filepath));

        readfile($filepath);
    }
}
{% endhighlight %}

<figure>
  <a href="/assets/img/posts/php_blog/3.jpg"><img src="/assets/img/posts/php_blog/3.jpg"></a>
  <figcaption>PHP File Upload and Download</figcaption>
</figure>

## SQL Security

### mysqli_connect()
  - Connect to MySqul with datas.
  - You should add host address, id, password, databse correctly as parameters.

### mysqli_prepare()
  - Create SQL query with formatting.

### mysqli_stmt_bind_param()
  - Fill sql query with the specific value.
  - Each type has each character like `s` means `string`.

### mysqli_stmt_execute()
  - Execute query.

### mysqli_stmt_get_result()
  - Get result from the query.

### mysqli_num_rows()
  - Get number of rows from the query result.

### Don't use mysqli_query()
  - Because `mysqli_query()` is a week for the security.
  - For example, if email value is "' or 1 = '1", then it's always true.

{% highlight php %}
<?php

$conn = mysqli_connect(
    'localhost',
    'root',
    'root',
    'myapp_test'
);

$_POST = [
    'email' => 'leehuhlee@gmail.com',
    'password' => 'secret'
];
['email' => $email, 'password' => $password] = $_POST;

// $result = mysqli_query($conn, "SELECT * FROM users WHERE email = '{$email}' LIMIT 1");

$stmt = mysqli_prepare($conn, 'SELECT * FROM users WHERE email = ? LIMIT 1');
mysqli_stmt_bind_param($stmt, 's', $email);
mysqli_stmt_execute($stmt);

$result = mysqli_stmt_get_result($stmt);

if(mysqli_num_rows($result)){
    echo 'Hello, world';
}
{% endhighlight %}

[Download](https://github.com/leehuhlee/PHPBlog){: .btn}